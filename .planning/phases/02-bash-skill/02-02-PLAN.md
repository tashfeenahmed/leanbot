---
phase: 02-bash-skill
plan: 02
type: execute
---

<objective>
Add sandboxing and security features to the bash skill execution script.

Purpose: Protect against accidental or malicious command execution by validating commands and restricting paths.

Output: Enhanced run.ts with command validation, dangerous command blocking, and path restriction.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/02-bash-skill/02-01-SUMMARY.md

**Key files to modify:**
@src/skills/bundled/bash/scripts/run.ts

**Patterns established in 02-01:**
- Standalone skill script reads SKILL_ARGS from env
- JSON output format with success, output, error, exitCode
- Timeout handling with SIGTERM -> SIGKILL escalation

**Decisions from 02-01 to follow:**
- user-invocable: false (agent-only skill)
- 60-second default timeout
- 30KB output truncation
- JSON output format for structured results
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dangerous command detection and blocking</name>
  <files>src/skills/bundled/bash/scripts/run.ts</files>
  <action>
Add a command validation function that blocks known dangerous patterns:

1. Create `validateCommand(command: string): { valid: boolean; reason?: string }` function
2. Block patterns:
   - `rm -rf /` or variations (rm with -rf and root path)
   - Fork bombs: `:(){ :|:& };:` and similar patterns
   - `/dev/sda` or other raw device writes
   - `mkfs` commands
   - `dd if=` with device targets
   - `> /etc/` or writing to system directories
   - Commands with `--no-preserve-root`

3. Call validateCommand before spawning process
4. If invalid, return error JSON without executing:
   ```json
   {
     "success": false,
     "output": "",
     "error": "Command blocked: [reason]",
     "exitCode": 126
   }
   ```

Note: This is basic protection, not a security sandbox. The goal is to prevent obvious accidents, not defend against determined attackers.
  </action>
  <verify>
Test blocked command:
```bash
SKILL_ARGS='{"command":"rm -rf /"}' npx tsx src/skills/bundled/bash/scripts/run.ts
# Should output JSON with success:false and "Command blocked" error
```

Test allowed command still works:
```bash
SKILL_ARGS='{"command":"echo hello"}' npx tsx src/skills/bundled/bash/scripts/run.ts
# Should output JSON with success:true
```
  </verify>
  <done>Dangerous command patterns are blocked with clear error messages, safe commands still execute</done>
</task>

<task type="auto">
  <name>Task 2: Add working directory validation</name>
  <files>src/skills/bundled/bash/scripts/run.ts</files>
  <action>
Add path validation to ensure cwd stays within allowed boundaries:

1. Create `validateCwd(cwd: string, basePath: string): { valid: boolean; reason?: string }` function
2. Validation rules:
   - Resolve cwd to absolute path using path.resolve
   - Ensure resolved path starts with basePath (workspace root)
   - Block path traversal attempts (../ that escape workspace)
   - Handle symlink resolution to prevent escape via symlinks

3. Get workspace root from SKILL_DIR env var (set by SkillExecutor) or default to process.cwd()
4. Call validateCwd in parseArgs after determining cwd
5. If invalid, return error JSON:
   ```json
   {
     "success": false,
     "output": "",
     "error": "Path blocked: [reason]",
     "exitCode": 126
   }
   ```

6. Update SKILL.md safety considerations to document the path restrictions
  </action>
  <verify>
Test path traversal blocked:
```bash
SKILL_ARGS='{"command":"ls","cwd":"/../../../etc"}' npx tsx src/skills/bundled/bash/scripts/run.ts
# Should output JSON with success:false and "Path blocked" error
```

Test valid cwd works:
```bash
SKILL_ARGS='{"command":"pwd","cwd":"./src"}' npx tsx src/skills/bundled/bash/scripts/run.ts
# Should output JSON with success:true and the resolved path
```

Ensure TypeScript compiles:
```bash
npx tsc --noEmit
```
  </verify>
  <done>Path traversal is blocked, workspace boundary enforced, SKILL.md updated with security notes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` succeeds
- [ ] Dangerous commands are blocked (rm -rf /, fork bombs)
- [ ] Path traversal attempts are blocked
- [ ] Normal commands still work
- [ ] SKILL.md documents the security features
</verification>

<success_criteria>
- Both tasks completed
- Command validation blocks dangerous patterns
- Path validation prevents workspace escape
- TypeScript compiles without errors
- All manual tests pass
- SKILL.md updated with security documentation
</success_criteria>

<output>
After completion, create `.planning/phases/02-bash-skill/02-02-SUMMARY.md`
</output>
